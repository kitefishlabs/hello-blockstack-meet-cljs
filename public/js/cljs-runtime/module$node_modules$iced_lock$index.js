shadow$provide.module$node_modules$iced_lock$index=function(global,process,require,module,exports,shadow$shims){(function(){var Lock,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};var iced=require("module$node_modules$iced_runtime$lib$main");exports.Lock=Lock=function(){function Lock(){this._open=
!0;this._waiters=[]}Lock.prototype.acquire=function(cb){return this._open?(this._open=!1,cb()):this._waiters.push(cb)};Lock.prototype.release=function(){if(this._waiters.length){var w=this._waiters.shift();return w()}return this._open=!0};Lock.prototype.open=function(){return this._open};return Lock}();var NamedLock=function(_super){function NamedLock(tab,name){this.tab=tab;this.name=name;NamedLock.__super__.constructor.call(this);this.refs=0}__extends(NamedLock,_super);NamedLock.prototype.incref=
function(){return++this.refs};NamedLock.prototype.decref=function(){return--this.refs};NamedLock.prototype.release=function(){NamedLock.__super__.release.call(this);if(0===this.decref())return delete this.tab.locks[this.name]};return NamedLock}(Lock);exports.Table=function(){function Table(){this.locks={}}Table.prototype.create=function(name){var l=new NamedLock(this,name);return this.locks[name]=l};Table.prototype.acquire=function(name,cb,wait){var __iced_deferrals;var ___iced_passed_deferral=iced.findDeferral(arguments);
var l=this.locks[name]||this.create(name);var was_open=l._open;l.incref();(function(_this){return function(__iced_k){if(wait||l._open)__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/iced/iced-lock/index.iced",funcname:"Table.acquire"}),l.acquire(__iced_deferrals.defer({lineno:69})),__iced_deferrals._fulfill();else return __iced_k(l=null)}})(this)(function(_this){return function(){return cb(l,was_open)}}(this))};Table.prototype.lookup=function(name){return this.locks[name]};
return Table}();var SingleFlighter=function(){function SingleFlighter(_arg){this.table=_arg.table;this.key=_arg.key;this.waiter=this.seqid=null;this.open=!0;this.refs=0}SingleFlighter.prototype._incref=function(){return++this.refs};SingleFlighter.prototype._decref=function(){if(0===--this.refs)return this.table._remove({key:this.key})};SingleFlighter.prototype._enter=function(_arg,cb){_arg=_arg.seqid;if(this.open)return this.open=!1,this.seqid=_arg,cb(null,this);if(null!=this.waiter){if(_arg>this.waiter.seqid){var tmp=
this.waiter;this.waiter={cb:cb,seqid:_arg};tmp.cb(Error("our seqid\x3d"+tmp.seqid+" was preempted by "+_arg))}else cb(Error("our seqid\x3d"+_arg+" is too stale (since "+this.waiter.seqid+" is ahead of us)"));return this._decref()}if(_arg>this.seqid)return this.waiter={seqid:_arg,cb:cb};cb(Error("our seqid\x3d"+_arg+" is too stale (since "+this.seqid+" is already in flight)"));return this._decref()};SingleFlighter.prototype.release=function(){if(null!=this.waiter){var cb=this.waiter;this.seqid=cb.seqid;
cb=cb.cb;this.waiter=null;cb(null,this)}else this.open=!0,this.seqid=null;return this._decref()};return SingleFlighter}();exports.SingleFlightTable=function(){function SingleFlightTable(){this._jobs={}}SingleFlightTable.prototype._create=function(_arg){_arg=_arg.key;return this._jobs[_arg]=new SingleFlighter({table:this,key:_arg})};SingleFlightTable.prototype._remove=function(_arg){return delete this._jobs[_arg.key]};SingleFlightTable.prototype.enter=function(_arg,cb){var seqid=_arg.seqid;_arg=_arg.key;
_arg=this._jobs[_arg]||this._create({key:_arg});_arg._incref();return _arg._enter({seqid:seqid},cb)};return SingleFlightTable}()}).call(this)}
//# sourceMappingURL=module$node_modules$iced_lock$index.js.map
