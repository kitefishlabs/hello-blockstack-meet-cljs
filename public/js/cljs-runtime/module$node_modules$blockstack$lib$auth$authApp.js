shadow$provide.module$node_modules$blockstack$lib$auth$authApp=function(global,process,require,module,exports,shadow$shims){function getTransitKey(){return localStorage.getItem(_authConstants.BLOCKSTACK_APP_PRIVATE_KEY_LABEL)}function generateAndStoreTransitKey(){var transitKey=(0,_index2.makeECPrivateKey)();localStorage.setItem(_authConstants.BLOCKSTACK_APP_PRIVATE_KEY_LABEL,transitKey);return transitKey}function redirectToSignInWithAuthRequest(){var authRequest=0<arguments.length&&void 0!==arguments[0]?
arguments[0]:(0,_index.makeAuthRequest)(),protocolURI=_utils.BLOCKSTACK_HANDLER+":"+authRequest,httpsURI=(1<arguments.length&&void 0!==arguments[1]?arguments[1]:_authConstants.DEFAULT_BLOCKSTACK_HOST)+"?authRequest\x3d"+authRequest;/Android|webOS|iPhone|iPad|iPod|Opera Mini/i.test(navigator.userAgent)?(_logger.Logger.info("detected mobile OS, sending to https"),window.location=httpsURI):(0,_customProtocolDetectionBlockstack2.default)(protocolURI,function(){_logger.Logger.warn("protocol handler not detected");
window.location=httpsURI},function(){_logger.Logger.info("protocol handler detected")},function(){_logger.Logger.warn("can not detect custom protocols on this browser");window.location=protocolURI})}function getAuthResponseToken(){var queryDict=_queryString2.default.parse(location.search);return queryDict.authResponse?queryDict.authResponse:""}Object.defineProperty(exports,"__esModule",{value:!0});exports.getTransitKey=getTransitKey;exports.generateAndStoreTransitKey=generateAndStoreTransitKey;exports.isUserSignedIn=
function(){return!!window.localStorage.getItem(_authConstants.BLOCKSTACK_STORAGE_LABEL)};exports.redirectToSignInWithAuthRequest=redirectToSignInWithAuthRequest;exports.redirectToSignIn=function(){var redirectURI=0<arguments.length&&void 0!==arguments[0]?arguments[0]:window.location.origin+"/",manifestURI=1<arguments.length&&void 0!==arguments[1]?arguments[1]:window.location.origin+"/manifest.json",scopes=2<arguments.length&&void 0!==arguments[2]?arguments[2]:_authConstants.DEFAULT_SCOPE;redirectURI=
(0,_index.makeAuthRequest)(generateAndStoreTransitKey(),redirectURI,manifestURI,scopes);redirectToSignInWithAuthRequest(redirectURI)};exports.getAuthResponseToken=getAuthResponseToken;exports.isSignInPending=function(){return!!getAuthResponseToken()};exports.handlePendingSignIn=function(){var nameLookupURL=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",authResponseToken=1<arguments.length&&void 0!==arguments[1]?arguments[1]:getAuthResponseToken(),transitKey=2<arguments.length&&void 0!==
arguments[2]?arguments[2]:getTransitKey();nameLookupURL||(nameLookupURL=(0,_jsontokens.decodeToken)(authResponseToken).payload,(0,_utils.isLaterVersion)(nameLookupURL.version,"1.3.0")&&null!==nameLookupURL.blockstackAPIUrl&&void 0!==nameLookupURL.blockstackAPIUrl&&(_logger.Logger.info("Overriding "+_config.config.network.blockstackAPIUrl+" "+("with "+nameLookupURL.blockstackAPIUrl)),_config.config.network.blockstackAPIUrl=nameLookupURL.blockstackAPIUrl,nameLookupURL=nameLookupURL.blockstackAPIUrl+
"/v1/names"),nameLookupURL=_config.config.network.blockstackAPIUrl+"/v1/names/");return(0,_index.verifyAuthResponse)(authResponseToken,nameLookupURL).then(function(isValid){if(!isValid)throw new _errors.LoginFailedError("Invalid authentication response.");isValid=(0,_jsontokens.decodeToken)(authResponseToken).payload;var appPrivateKey=isValid.private_key,coreSessionToken=isValid.core_token;if((0,_utils.isLaterVersion)(isValid.version,"1.1.0"))if(void 0!==transitKey&&null!=transitKey){if(void 0!==
isValid.private_key&&null!==isValid.private_key)try{appPrivateKey=(0,_authMessages.decryptPrivateKey)(transitKey,isValid.private_key)}catch(e){_logger.Logger.warn("Failed decryption of appPrivateKey, will try to use as given");try{(0,_utils.hexStringToECPair)(isValid.private_key)}catch(ecPairError){throw new _errors.LoginFailedError("Failed decrypting appPrivateKey. Usually means that the transit key has changed during login.");}}if(void 0!==coreSessionToken&&null!==coreSessionToken)try{coreSessionToken=
(0,_authMessages.decryptPrivateKey)(transitKey,coreSessionToken)}catch(e$49){_logger.Logger.info("Failed decryption of coreSessionToken, will try to use as given")}}else throw new _errors.LoginFailedError("Authenticating with protocol \x3e 1.1.0 requires transit key, and none found.");var hubUrl=_authConstants.BLOCKSTACK_DEFAULT_GAIA_HUB_URL,gaiaAssociationToken=void 0;(0,_utils.isLaterVersion)(isValid.version,"1.2.0")&&null!==isValid.hubUrl&&void 0!==isValid.hubUrl&&(hubUrl=isValid.hubUrl);(0,_utils.isLaterVersion)(isValid.version,
"1.3.0")&&null!==isValid.associationToken&&void 0!==isValid.associationToken&&(gaiaAssociationToken=isValid.associationToken);var userData={username:isValid.username,profile:isValid.profile,decentralizedID:isValid.iss,identityAddress:(0,_index2.getAddressFromDID)(isValid.iss),appPrivateKey:appPrivateKey,coreSessionToken:coreSessionToken,authResponseToken:authResponseToken,hubUrl:hubUrl,gaiaAssociationToken:gaiaAssociationToken};appPrivateKey=isValid.profile_url;return null!==userData.profile&&void 0!==
userData.profile||void 0===appPrivateKey||null===appPrivateKey?(userData.profile=isValid.profile,window.localStorage.setItem(_authConstants.BLOCKSTACK_STORAGE_LABEL,JSON.stringify(userData)),userData):fetch(appPrivateKey).then(function(response){if(response.ok)return response.text().then(function(responseText){return JSON.parse(responseText)}).then(function(wrappedProfile){return(0,_profiles.extractProfile)(wrappedProfile[0].token)}).then(function(profile){userData.profile=profile;window.localStorage.setItem(_authConstants.BLOCKSTACK_STORAGE_LABEL,
JSON.stringify(userData));return userData});userData.profile=Object.assign({},DEFAULT_PROFILE);window.localStorage.setItem(_authConstants.BLOCKSTACK_STORAGE_LABEL,JSON.stringify(userData));return userData})})};exports.loadUserData=function(){return JSON.parse(window.localStorage.getItem(_authConstants.BLOCKSTACK_STORAGE_LABEL))};exports.signUserOut=function(){var redirectURL=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;window.localStorage.removeItem(_authConstants.BLOCKSTACK_STORAGE_LABEL);
window.localStorage.removeItem(_storage.BLOCKSTACK_GAIA_HUB_LABEL);null!==redirectURL&&(window.location=redirectURL)};var _queryString2=(global=require("module$node_modules$query_string$index"))&&global.__esModule?global:{default:global},_jsontokens=require("module$node_modules$jsontokens$lib$index"),_customProtocolDetectionBlockstack2=(global=require("module$node_modules$custom_protocol_detection_blockstack$index"))&&global.__esModule?global:{default:global},_index=require("module$node_modules$blockstack$lib$auth$index"),
_utils=require("module$node_modules$blockstack$lib$utils"),_index2=require("module$node_modules$blockstack$lib$index"),_errors=require("module$node_modules$blockstack$lib$errors"),_authMessages=require("module$node_modules$blockstack$lib$auth$authMessages"),_authConstants=require("module$node_modules$blockstack$lib$auth$authConstants"),_storage=require("module$node_modules$blockstack$lib$storage$index"),_profiles=require("module$node_modules$blockstack$lib$profiles$index"),_logger=require("module$node_modules$blockstack$lib$logger"),
_config=require("module$node_modules$blockstack$lib$config"),DEFAULT_PROFILE={"@type":"Person","@context":"http://schema.org"}}
//# sourceMappingURL=module$node_modules$blockstack$lib$auth$authApp.js.map
