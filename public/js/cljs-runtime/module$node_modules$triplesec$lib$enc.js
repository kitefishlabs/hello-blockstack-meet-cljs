shadow$provide.module$node_modules$triplesec$lib$enc=function(global,process,require,module,exports,shadow$shims){(function(){var __hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};var iced=require("module$node_modules$iced_runtime$lib$main");var WordArray=require("module$node_modules$triplesec$lib$wordarray").WordArray;
var salsa20=require("module$node_modules$triplesec$lib$salsa20");var AES=require("module$node_modules$triplesec$lib$aes").AES;var TwoFish=require("module$node_modules$triplesec$lib$twofish").TwoFish;var ctr=require("module$node_modules$triplesec$lib$ctr");var HMAC_SHA256=require("module$node_modules$triplesec$lib$combine");var Base$jscomp$0=HMAC_SHA256.XOR;var Concat=HMAC_SHA256.Concat;require("module$node_modules$triplesec$lib$sha512");var PBKDF2=require("module$node_modules$triplesec$lib$pbkdf2").PBKDF2;
var Scrypt=require("module$node_modules$triplesec$lib$scrypt").Scrypt;var util=require("module$node_modules$triplesec$lib$util");var prng=require("module$node_modules$triplesec$lib$prng");var make_esc=require("module$node_modules$iced_error$index").make_esc;HMAC_SHA256=require("module$node_modules$triplesec$lib$hmac").HMAC_SHA256;var V={1:{header:[479516638,1],salt_size:8,xsalsa20_rev:!0,kdf:{klass:PBKDF2,opts:{c:1024,klass:Base$jscomp$0}},hmac_key_size:96,version:1},2:{header:[479516638,2],salt_size:16,
xsalsa20_rev:!0,kdf:{klass:Scrypt,opts:{c:64,klass:Base$jscomp$0,N:12,r:8,p:1}},hmac_key_size:96,version:2},3:{header:[479516638,3],salt_size:16,xsalsa20_rev:!1,kdf:{klass:Scrypt,opts:{c:1,klass:HMAC_SHA256,N:15,r:8,p:1}},hmac_key_size:96,version:3}};exports.CURRENT_VERSION=3;Base$jscomp$0=function(){function Base(_arg){var key=_arg.key;_arg=_arg.version;this.version=V[null!=_arg?_arg:3];if(null==this.version)throw Error("unknown version: "+_arg);this.set_key(key);this.derived_keys={}}Base.prototype.kdf=
function(_arg,cb){var args,dkLen,end,i,k,key,keys,len,lens,order,raw,salt_hex,v,__iced_deferrals;var ___iced_passed_deferral=iced.findDeferral(arguments);var salt=_arg.salt;var extra_keymaterial=_arg.extra_keymaterial;var progress_hook=_arg.progress_hook;(function(_this){return function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced",funcname:"Base.kdf"});_this._check_scrubbed(_this.key,"in KDF",cb,__iced_deferrals.defer({lineno:97}));
__iced_deferrals._fulfill()}})(this)(function(_this){return function(){salt_hex=salt.to_hex();key=_this.key.clone();(function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced",funcname:"Base.kdf"});_this._check_scrubbed(key,"KDF",cb,__iced_deferrals.defer({lineno:105}));__iced_deferrals._fulfill()})(function(){(function(__iced_k$jscomp$0){if(null==(keys=_this.derived_keys[salt_hex])){_this._kdf=new _this.version.kdf.klass(_this.version.kdf.opts);
lens={hmac:_this.version.hmac_key_size,aes:AES.keySize,twofish:TwoFish.keySize,salsa20:salsa20.Salsa20.keySize};order=["hmac","aes","twofish","salsa20"];dkLen=extra_keymaterial||0;for(k in lens)v=lens[k],dkLen+=v;args={dkLen:dkLen,key:key,progress_hook:progress_hook,salt:salt};(function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced",funcname:"Base.kdf"});_this._kdf.run(args,__iced_deferrals.defer({assign_fn:function(){return function(JSCompiler_OptimizeArgumentsArray_p17){return raw=
JSCompiler_OptimizeArgumentsArray_p17}}(),lineno:124}));__iced_deferrals._fulfill()})(function(){var _len;keys={};var _i=i=0;for(_len=order.length;_i<_len;_i++)k=order[_i],v=lens[k],len=v/4,end=i+len,keys[k]=new WordArray(raw.words.slice(i,end)),i=end;keys.extra=(new WordArray(raw.words.slice(end))).to_buffer();return __iced_k$jscomp$0(_this.derived_keys[salt_hex]=keys)})}else return __iced_k$jscomp$0()})(function(){return cb(null,keys)})})}}(this))};Base.prototype.set_key=function(key){if(null!=
key){if(key=WordArray.from_buffer(key),!this.key||!this.key.equal(key))return this.scrub(),this.key=key}else return this.scrub()};Base.prototype._check_scrubbed=function(key,where,ecb,okcb){return null==key||key.is_scrubbed()?ecb(Error(""+where+": Failed due to scrubbed key!"),null):okcb()};Base.prototype.sign=function(_arg,cb){var out,__iced_deferrals;var ___iced_passed_deferral=iced.findDeferral(arguments);var input=_arg.input;var key=_arg.key;var salt=_arg.salt;var progress_hook=_arg.progress_hook;
(function(_this){return function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced",funcname:"Base.sign"});_this._check_scrubbed(key,"HMAC",cb,__iced_deferrals.defer({lineno:182}));__iced_deferrals._fulfill()}})(this)(function(_this){return function(){input=(new WordArray(_this.version.header)).concat(salt).concat(input);(function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,
filename:"/Users/max/src/keybase/triplesec/src/enc.iced",funcname:"Base.sign"});Concat.bulk_sign({key:key,input:input,progress_hook:progress_hook},__iced_deferrals.defer({assign_fn:function(){return function(JSCompiler_OptimizeArgumentsArray_p18){return out=JSCompiler_OptimizeArgumentsArray_p18}}(),lineno:184}));__iced_deferrals._fulfill()})(function(){input.scrub();return cb(null,out)})}}(this))};Base.prototype.run_salsa20=function(_arg,cb){var args,ct,__iced_deferrals;var ___iced_passed_deferral=
iced.findDeferral(arguments);var input=_arg.input;var key=_arg.key;var iv=_arg.iv;var output_iv=_arg.output_iv;var progress_hook=_arg.progress_hook;(function(_this){return function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced",funcname:"Base.run_salsa20"});_this._check_scrubbed(key,"Salsa20",cb,__iced_deferrals.defer({lineno:200}));__iced_deferrals._fulfill()}})(this)(function(_this){return function(){args=
{input:input,progress_hook:progress_hook,key:key,iv:iv};_this.version.xsalsa20_rev&&(args.key=key.clone().endian_reverse(),args.iv=iv.clone().endian_reverse());(function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced",funcname:"Base.run_salsa20"});salsa20.bulk_encrypt(args,__iced_deferrals.defer({assign_fn:function(){return function(JSCompiler_OptimizeArgumentsArray_p19){return ct=JSCompiler_OptimizeArgumentsArray_p19}}(),
lineno:212}));__iced_deferrals._fulfill()})(function(){output_iv&&(ct=iv.clone().concat(ct));_this.version.xsalsa20_rev&&(args.key.scrub(),args.iv.scrub());return cb(null,ct)})}}(this))};Base.prototype.run_twofish=function(_arg,cb){var block_cipher,ct,__iced_deferrals;var ___iced_passed_deferral=iced.findDeferral(arguments);var input=_arg.input;var key=_arg.key;var iv=_arg.iv;var progress_hook=_arg.progress_hook;(function(_this){return function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,
{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced",funcname:"Base.run_twofish"});_this._check_scrubbed(key,"TwoFish",cb,__iced_deferrals.defer({lineno:235}));__iced_deferrals._fulfill()}})(this)(function(_this){return function(){block_cipher=new TwoFish(key);(function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced",funcname:"Base.run_twofish"});ctr.bulk_encrypt({block_cipher:block_cipher,
iv:iv,input:input,progress_hook:progress_hook,what:"twofish"},__iced_deferrals.defer({assign_fn:function(){return function(JSCompiler_OptimizeArgumentsArray_p20){return ct=JSCompiler_OptimizeArgumentsArray_p20}}(),lineno:237}));__iced_deferrals._fulfill()})(function(){block_cipher.scrub();return cb(null,iv.clone().concat(ct))})}}(this))};Base.prototype.run_aes=function(_arg,cb){var block_cipher,ct,__iced_deferrals;var ___iced_passed_deferral=iced.findDeferral(arguments);var input=_arg.input;var key=
_arg.key;var iv=_arg.iv;var progress_hook=_arg.progress_hook;(function(_this){return function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced",funcname:"Base.run_aes"});_this._check_scrubbed(key,"AES",cb,__iced_deferrals.defer({lineno:252}));__iced_deferrals._fulfill()}})(this)(function(_this){return function(){block_cipher=new AES(key);(function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,
filename:"/Users/max/src/keybase/triplesec/src/enc.iced",funcname:"Base.run_aes"});ctr.bulk_encrypt({block_cipher:block_cipher,iv:iv,input:input,progress_hook:progress_hook,what:"aes"},__iced_deferrals.defer({assign_fn:function(){return function(JSCompiler_OptimizeArgumentsArray_p21){return ct=JSCompiler_OptimizeArgumentsArray_p21}}(),lineno:254}));__iced_deferrals._fulfill()})(function(){block_cipher.scrub();return cb(null,iv.clone().concat(ct))})}}(this))};Base.prototype.scrub=function(){var algo,
salt;null!=this.key&&this.key.scrub();if(null!=this.derived_keys){var _ref1=this.derived_keys;for(salt in _ref1){var key_ring=_ref1[salt];for(algo in key_ring){var key=key_ring[algo];"extra"!==algo&&key.scrub()}}}this.derived_keys={};null!=this.salt&&this.salt.scrub();return this.key=this.salt=null};Base.prototype.clone_derived_keys=function(){var algo,salt;var ret=null;if(null!=this.derived_keys){ret={};var _ref1=this.derived_keys;for(salt in _ref1){var key_ring=_ref1[salt];ret[salt]={};for(algo in key_ring){var key=
key_ring[algo];ret[salt][algo]="extra"===algo?key:key.clone()}}}return ret};return Base}();var Encryptor=function(_super){function Encryptor(_arg){var key=_arg.key;var rng=_arg.rng;Encryptor.__super__.constructor.call(this,{key:key,version:_arg.version});this.rng=rng||prng.generate}__extends(Encryptor,_super);Encryptor.prototype.pick_random_ivs=function(_arg,cb){var k,v,__iced_deferrals;var ___iced_passed_deferral=iced.findDeferral(arguments);var iv_lens={aes:AES.ivSize,twofish:TwoFish.ivSize,salsa20:salsa20.Salsa20.ivSize};
var ivs={};(function(_this){return function(__iced_k$jscomp$1){var _k;var _keys=function(){var _results1=[];for(_k in iv_lens)_results1.push(_k);return _results1}();var _i=0;var _while=function(__iced_k$jscomp$0){var _next=function(){return iced.trampoline(function(){++_i;return _while(__iced_k$jscomp$0)})};if(_i<_keys.length)k=_keys[_i],v=iv_lens[k],function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced",
funcname:"Encryptor.pick_random_ivs"});_this.rng(v,__iced_deferrals.defer({assign_fn:function(__slot_1,__slot_2){return function(JSCompiler_OptimizeArgumentsArray_p22){return __slot_1[__slot_2]=JSCompiler_OptimizeArgumentsArray_p22}}(ivs,k),lineno:377}));__iced_deferrals._fulfill()}(_next);else return __iced_k$jscomp$0()};_while(__iced_k$jscomp$1)}})(this)(function(_this){return function(){return cb(ivs)}}(this))};Encryptor.prototype.resalt=function(_arg,cb){var __iced_deferrals;var ___iced_passed_deferral=
iced.findDeferral(arguments);var salt=_arg.salt;var extra_keymaterial=_arg.extra_keymaterial;var progress_hook=_arg.progress_hook;var err=null;(function(_this){return function(__iced_k$jscomp$0){if(null==salt)(function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced",funcname:"Encryptor.resalt"});_this.rng(_this.version.salt_size,__iced_deferrals.defer({assign_fn:function(__slot_1){return function(JSCompiler_OptimizeArgumentsArray_p23){return __slot_1.salt=
JSCompiler_OptimizeArgumentsArray_p23}}(_this),lineno:393}));__iced_deferrals._fulfill()})(__iced_k$jscomp$0);else return __iced_k$jscomp$0(salt.length!==_this.version.salt_size?err=Error("Need a salt of exactly "+_this.version.salt_size+" bytes (got "+salt.length+")"):_this.salt=WordArray.alloc(salt))}})(this)(function(_this){return function(){(function(__iced_k$jscomp$0){if(null==err)(function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced",
funcname:"Encryptor.resalt"});_this.kdf({extra_keymaterial:extra_keymaterial,progress_hook:progress_hook,salt:_this.salt},__iced_deferrals.defer({assign_fn:function(__slot_1){return function(JSCompiler_OptimizeArgumentsArray_p24,JSCompiler_OptimizeArgumentsArray_p25){err=JSCompiler_OptimizeArgumentsArray_p24;return __slot_1.keys=JSCompiler_OptimizeArgumentsArray_p25}}(_this),lineno:399}));__iced_deferrals._fulfill()})(__iced_k$jscomp$0);else return __iced_k$jscomp$0()})(function(){return cb(err,_this.keys)})}}(this))};
Encryptor.prototype.run=function(_arg,cb){var ct1,ct2,ct3,ivs,pt,ret,sig,__iced_deferrals;var ___iced_passed_deferral=iced.findDeferral(arguments);var data=_arg.data;var salt=_arg.salt;var extra_keymaterial=_arg.extra_keymaterial;var progress_hook=_arg.progress_hook;var esc=make_esc(cb,"Encryptor::run");(function(_this){return function(__iced_k){if(null!=salt||null==_this.salt)__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced",
funcname:"Encryptor.run"}),_this.resalt({salt:salt,extra_keymaterial:extra_keymaterial,progress_hook:progress_hook},esc(__iced_deferrals.defer({lineno:430}))),__iced_deferrals._fulfill();else return __iced_k()}})(this)(function(_this){return function(){(function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced",funcname:"Encryptor.run"});_this.pick_random_ivs({progress_hook:progress_hook},__iced_deferrals.defer({assign_fn:function(){return function(JSCompiler_OptimizeArgumentsArray_p26){return ivs=
JSCompiler_OptimizeArgumentsArray_p26}}(),lineno:431}));__iced_deferrals._fulfill()})(function(){pt=WordArray.from_buffer(data);(function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced",funcname:"Encryptor.run"});_this.run_salsa20({input:pt,key:_this.keys.salsa20,progress_hook:progress_hook,iv:ivs.salsa20,output_iv:!0},esc(__iced_deferrals.defer({assign_fn:function(){return function(JSCompiler_OptimizeArgumentsArray_p27){return ct1=
JSCompiler_OptimizeArgumentsArray_p27}}(),lineno:433})));__iced_deferrals._fulfill()})(function(){(function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced",funcname:"Encryptor.run"});_this.run_twofish({input:ct1,key:_this.keys.twofish,progress_hook:progress_hook,iv:ivs.twofish},esc(__iced_deferrals.defer({assign_fn:function(){return function(JSCompiler_OptimizeArgumentsArray_p28){return ct2=JSCompiler_OptimizeArgumentsArray_p28}}(),
lineno:434})));__iced_deferrals._fulfill()})(function(){(function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced",funcname:"Encryptor.run"});_this.run_aes({input:ct2,key:_this.keys.aes,progress_hook:progress_hook,iv:ivs.aes},esc(__iced_deferrals.defer({assign_fn:function(){return function(JSCompiler_OptimizeArgumentsArray_p29){return ct3=JSCompiler_OptimizeArgumentsArray_p29}}(),lineno:435})));__iced_deferrals._fulfill()})(function(){(function(__iced_k){__iced_deferrals=
new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced",funcname:"Encryptor.run"});_this.sign({input:ct3,key:_this.keys.hmac,progress_hook:progress_hook,salt:_this.salt},esc(__iced_deferrals.defer({assign_fn:function(){return function(JSCompiler_OptimizeArgumentsArray_p30){return sig=JSCompiler_OptimizeArgumentsArray_p30}}(),lineno:436})));__iced_deferrals._fulfill()})(function(){ret=(new WordArray(_this.version.header)).concat(_this.salt).concat(sig).concat(ct3).to_buffer();
util.scrub_buffer(data);return cb(null,ret)})})})})})}}(this))};Encryptor.prototype.clone=function(){var _ref1,_ref2;var ret=new Encryptor({key:null!=(_ref1=this.key)?_ref1.to_buffer():void 0,rng:this.rng,version:null!=(_ref2=this.version)?_ref2.version:void 0});ret.derived_keys=this.clone_derived_keys();return ret};return Encryptor}(Base$jscomp$0);exports.V=V;exports.encrypt=function(_arg,cb){var err,ret,__iced_deferrals;var ___iced_passed_deferral=iced.findDeferral(arguments);var key=_arg.key;var data=
_arg.data;var rng=_arg.rng;var progress_hook=_arg.progress_hook;var enc=new Encryptor({key:key,rng:rng,version:_arg.version});(function(_this){return function(__iced_k){__iced_deferrals=new iced.Deferrals(__iced_k,{parent:___iced_passed_deferral,filename:"/Users/max/src/keybase/triplesec/src/enc.iced"});enc.run({data:data,progress_hook:progress_hook},__iced_deferrals.defer({assign_fn:function(){return function(JSCompiler_OptimizeArgumentsArray_p31,JSCompiler_OptimizeArgumentsArray_p32){err=JSCompiler_OptimizeArgumentsArray_p31;
return ret=JSCompiler_OptimizeArgumentsArray_p32}}(),lineno:475}));__iced_deferrals._fulfill()}})(this)(function(_this){return function(){enc.scrub();return cb(err,ret)}}(this))};exports.Base=Base$jscomp$0;exports.Encryptor=Encryptor}).call(this)}
//# sourceMappingURL=module$node_modules$triplesec$lib$enc.js.map
